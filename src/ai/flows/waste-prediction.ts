// This is an autogenerated file from Firebase Studio.

'use server';

/**
 * @fileOverview Predicts the amount of food that is wasted in different areas based on historical data.
 *
 * - predictWaste - A function that predicts food waste.
 * - WastePredictionInput - The input type for the predictWaste function.
 * - WastePredictionOutput - The return type for the predictWaste function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const WastePredictionInputSchema = z.object({
  area: z.string().describe('The area for which to predict food waste.'),
  historicalData: z
    .string()
    .describe(
      'Historical data on food waste in the area, including dates and amounts.'
    ),
});

export type WastePredictionInput = z.infer<typeof WastePredictionInputSchema>;

const WastePredictionOutputSchema = z.object({
  predictedWasteAmount: z
    .string()
    .describe('The predicted amount of food waste in the area.'),
  confidenceLevel: z
    .string()
    .describe('The confidence level of the prediction (e.g., high, medium, low).'),
  suggestedActions: z
    .string()
    .describe('Suggested actions for volunteers based on the prediction.'),
});

export type WastePredictionOutput = z.infer<typeof WastePredictionOutputSchema>;

export async function predictWaste(
  input: WastePredictionInput,
  // This callback will be invoked when the full response is available.
  onDone: (output: WastePredictionOutput) => void
) {
  const {stream, response} = predictWasteFlow(input);

  // We can optionally process the stream as it comes in.
  (async () => {
    for await (const chunk of stream) {
      // Here, you could process chunks if needed. For this use case,
      // we will just wait for the full response below.
    }
  })();

  // The `response` promise resolves when the full structured object is available.
  const result = await response;
  onDone(result);
}

const prompt = ai.definePrompt({
  name: 'wastePredictionPrompt',
  input: {schema: WastePredictionInputSchema},
  output: {schema: WastePredictionOutputSchema},
  prompt: `You are an expert in predicting food waste based on historical data.

  Given the following area and historical data, predict the amount of food that will be wasted and suggest actions for volunteers.

  Area: {{{area}}}
  Historical Data: {{{historicalData}}}

  Consider factors such as seasonality, local events, and recent trends in food consumption.

  Provide the predicted waste amount, a confidence level for the prediction, and suggested actions for volunteers to mitigate waste.
  `,
});

const predictWasteFlow = ai.defineFlow(
  {
    name: 'predictWasteFlow',
    inputSchema: WastePredictionInputSchema,
    outputSchema: WastePredictionOutputSchema,
  },
  async (input, streamingCallback) => {
    const {stream, response} = await prompt(input, streamingCallback);
    // The flow must return the full response.
    return (await response)!;
  }
);
